<!DOCTYPE html>
<html>
  <head>
    <title>Michilog Map</title>
    <meta name="viewport" content="initial-scale=1.0" />
    <meta charset="utf-8" />
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
      integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
      crossorigin="anonymous"
    />
    <!-- Bootstrap Javascript(jQueryå«ã‚€) -->
    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
      integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
      integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
      crossorigin="anonymous"
    ></script>
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html,
      body {
        height: 94%;
        margin: 0;
        padding: 0;
      }
      div {
        margin: 4px;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-8">
          <form class="form-inline">
            <div class="form-group">
              <label>å‡ºç™ºåœ°ï¼š </label>
              <input type="text" class="form-control" size="30" id="origin" />
            </div>
            <div class="form-group">
              <label> â†’ã€€ç›®çš„åœ°ï¼š </label>
              <input
                type="text"
                class="form-control"
                size="30"
                id="destination"
              />
            </div>
            <button type="submit" class="btn btn-default" id="search">
              çµŒè·¯æ¢ç´¢
            </button>
          </form>
        </div>
        <div class="col-3">
          <div class="form-inline">
            <div class="form-group">
              <label>ç¨®åˆ¥ï¼š</label>
              <select id="evaluation" name="evaluation" class="form-control">
                <option value="good">ã„ã„ã­ã‡ï½ğŸ‘</option>
                <option value="bad">æ‚ªã„ã­ã‡ï½ğŸ‘</option>
              </select>
              <div></div>
              <button type="submit" class="btn btn-default" id="routeSearch">
                routeSearch
              </button>
              <div></div>
              <!-- <button type="submit" class="btn btn-default" id="snsLink">
                  ã‚¹ãƒãƒƒãƒˆæ¤œç´¢
              </button> -->
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="map"></div>
    <script>
      // å‚è€ƒã‚µã‚¤ãƒˆï¼šãƒ™ãƒ¼ã‚¹ https://blog.codecamp.jp/googlemaps-api
      // å‚è€ƒã‚µã‚¤ãƒˆï¼šå…¬å¼ https://developers.google.com/maps/documentation/javascript/adding-a-google-map
      // å‚è€ƒã‚µã‚¤ãƒˆï¼šè¤‡æ•°ãƒãƒ¼ã‚«ãƒ¼ï¼ˆå‹•ã‹ãªã„ã‘ã©ã€èª¬æ˜ãŒä¸å¯§ï¼‰ https://www.tam-tam.co.jp/tipsnote/javascript/post7755.html
      // å‚è€ƒã‚µã‚¤ãƒˆï¼šè¤‡æ•°ãƒãƒ¼ã‚«ãƒ¼ https://leben.mobi/blog/google_maps_api_macker/javascript/
      var map;
      var marker = [];
      var infoWindow = [];
      var markerDataGood = [
        // ãƒãƒ¼ã‚«ãƒ¼ã‚’ç«‹ã¦ã‚‹å ´æ‰€åãƒ»ç·¯åº¦ãƒ»çµŒåº¦
        {
          name: '<a href="http://google.com">ãã‚Œã„ãªé“</a>',
          lat: 34.387355,
          lng: 132.480769
        },
        // {
        //   name: "è»ŠãŒå°‘ãªã„",
        //   lat: 34.3665,
        //   lng: 132.469984
        // },
        {
          name: "ã‚¹ãƒˆãƒ¬ã‚¹ãŒãªã„",
          lat: 34.390757,
          lng: 132.483073
        },
        {
          name: "è¦‹é€šã—ãŒè‰¯ã„",
          lat: 34.389274,
          lng: 132.487308
        },
        // {
        //   name: "äººé€šã‚ŠãŒå°‘ãªã„",
        //   lat: 34.364485,
        //   lng: 132.4676
        // },
        {
          name: "äººé€šã‚ŠãŒå°‘ãªã„",
          lat: 34.386676,
          lng: 132.496423
        }
      ];
      var markerDataBad = [
        // ãƒãƒ¼ã‚«ãƒ¼ã‚’ç«‹ã¦ã‚‹å ´æ‰€åãƒ»ç·¯åº¦ãƒ»çµŒåº¦
        {
          name: "é“ãŒç‹­ã„",
          lat: 34.391680,
          lng: 132.488088
        },
        {
          name: "æ€–ã„",
          lat: 34.391275,
          lng: 132.489823
        },
        {
          name: "è»Šã«ã‚ˆã£ã¦ã¯æ›²ãŒã‚Œãªã„",
          lat: 34.390073,
          lng: 132.495040
        },
        {
          name: "è¦‹é€šã—ãŒæ‚ªã„",
          lat: 34.392125,
          lng: 132.495053
        },
      ];
           
      // ãƒãƒƒãƒ—è¡¨ç¤ºå‡¦ç†
      function initMap() {
        // åœ°å›³ã®ä½œæˆ
        var defaultPosition = new google.maps.LatLng({
          lat: 34.366,
          lng: 132.471
        }); // ã¨ã‚Šã‚ãˆãšæ±ºã‚æ‰“ã¡ãƒ»ãƒ»ãƒ»

        map = new google.maps.Map(document.getElementById("map"), {
          center: new google.maps.LatLng(34.391531, 132.490962), 
          zoom: 16, 
          mapTypeId: google.maps.MapTypeId.ROADMAP
        });

        src = "ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒãƒ¼ãƒˆåºƒå³¶æ®µåŸæ±åº—";
        dst = "ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«åºƒå³¶åºœä¸­";
        $("#origin").val(src);
        $("#destination").val(dst);
        let routeRequest = {
          origin: new google.maps.LatLng(34.386424, 132.480188), // å‡ºç™ºåœ°
          destination: new google.maps.LatLng(34.393155, 132.498090), // ç›®çš„åœ°
          travelMode: google.maps.DirectionsTravelMode.DRIVING, 
        };
      
        let d = new google.maps.DirectionsService(); // ãƒ«ãƒ¼ãƒˆæ¤œç´¢ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        let r = new google.maps.DirectionsRenderer({ // ãƒ«ãƒ¼ãƒˆæç”»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
          map: map, // æç”»å…ˆã®åœ°å›³
          preserveViewport: true, // æç”»å¾Œã«ä¸­å¿ƒç‚¹ã‚’ãšã‚‰ã•ãªã„
          suppressMarkers: true
        });
        // ãƒ«ãƒ¼ãƒˆæ¤œç´¢
        d.route(routeRequest, function(result, status){
        // OKã®å ´åˆãƒ«ãƒ¼ãƒˆæç”»
          if (status == google.maps.DirectionsStatus.OK) {
              r.setDirections(result);
          }
        });

        //dispMakers($("[name=evaluation]").val());
      }
      // ãƒãƒ¼ã‚«ãƒ¼ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
      function markerEvent(i) {
        marker[i].addListener("click", function() {
          // ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ã
          infoWindow[i].open(map, marker[i]); // å¹ãå‡ºã—ã®è¡¨ç¤º
        });
      }
      // ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤ºå‡¦ç†ï¼ˆãƒãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨å‰æï¼‰
      function dispMakers(eval) {
        // ãƒãƒ¼ã‚«ãƒ¼ã‚’åˆæœŸåŒ–ï¼ˆæ—¢ã«ã‚ã‚‹ã‚„ã¤ã‚’å‰Šé™¤ï¼‰
        for (var i = 0; i < marker.length; i++) {
          marker[i].setMap(null);
        }
        // ãƒãƒ¼ã‚«ãƒ¼æ¯ã®å‡¦ç†
        var markerData = getMarkerData(eval);
        for (var i = 0; i < markerData.length; i++) {
          markerLatLng = new google.maps.LatLng({
            lat: markerData[i]["lat"],
            lng: markerData[i]["lng"]
          }); // ç·¯åº¦çµŒåº¦ã®ãƒ‡ãƒ¼ã‚¿ä½œæˆ
          marker[i] = new google.maps.Marker({
            // ãƒãƒ¼ã‚«ãƒ¼ã®è¿½åŠ 
            position: markerLatLng, // ãƒãƒ¼ã‚«ãƒ¼ã‚’ç«‹ã¦ã‚‹ä½ç½®ã‚’æŒ‡å®š
            icon: getMarkerIcon(eval),
            animation: google.maps.Animation.DROP
          });
          infoWindow[i] = new google.maps.InfoWindow({
            // å¹ãå‡ºã—ã®è¿½åŠ 
            content: '<div class="map">' + markerData[i]["name"] + "</div>" // å¹ãå‡ºã—ã«è¡¨ç¤ºã™ã‚‹å†…å®¹
          });
          markerEvent(i); // ãƒãƒ¼ã‚«ãƒ¼ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
          // ãƒãƒ¼ã‚«ãƒ¼ã‚’è¨­ç½®
          marker[i].setMap(map);
        }
      }
      // è©•ä¾¡ç¨®åˆ¥ã«å¿œã˜ãŸãƒãƒ¼ã‚«ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
      function getMarkerData(eval) {
        if (eval == `good`) {
          return markerDataGood;
        } else {
          return markerDataBad;
        }
      }
      // è©•ä¾¡ç¨®åˆ¥ã«å¿œã˜ãŸãƒãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã®å–å¾—
      function getMarkerIcon(eval) {
        if (eval == `good`) {
          //return "https://maps.google.com/mapfiles/ms/icons/red-dot.png";
          // return {
          //   path: "M -8,-8 8,8 M 8,-8 -8,8", //åº§æ¨™ï¼ˆÃ—ï¼‰
          //   strokeColor: "#000000", //ç·šã®è‰²
          //   strokeWeight: 4.0, //ç·šã®å¤ªã•
          //   scaledSize: new google.maps.Size(40, 40) //ã‚µã‚¤ã‚º
          // };
          return {
            url:
              //"https://chart.apis.google.com/chart?chst=d_map_spin&chld=0.8|0|ff4500|10|_|good"
              "https://chart.apis.google.com/chart?chst=d_map_pin_letter_withshadow&chld=%E2%80%A2|ff6347"
          };
        } else {
          return {
            url:
              //"https://chart.apis.google.com/chart?chst=d_map_spin&chld=0.8|0|0000ff|10|_|bad"
              "https://chart.apis.google.com/chart?chst=d_map_pin_letter_withshadow&chld=%E2%80%A2|4169e1"
          };
        }
      }
      
      // åœ°åå–å¾—ä¾‹  API GocodeAPIã‚’æœ‰åŠ¹ã«ã™ã‚‹å¿…è¦ã‚ã‚Š
      function getLocalAreaName(){
        let testLatLng = new google.maps.LatLng({
          lat: 34.387246,
          lng: 132.455530
        }); 
        let geocoder = new google.maps.Geocoder;
        let areaName = '';

        geocoder.geocode({'location': testLatLng}, function(results, status) {
          if (status === 'OK') {
            console.log(results);
            let searchArea = results[0].address_components.filter(function(component) {
              return component.types.indexOf("sublocality_level_2") > -1;
            });
            console.log(searchArea[0].long_name);
            areaName = searchArea[0].long_name;
          } else {
            window.alert('Geocoder failed due to: ' + status);
          }
        });
      }
      // çµŒç”±ã‚ã‚ŠçµŒè·¯è¡¨ç¤ºAPI
      function searchRoute(eval){
        let src = document.getElementById("origin").value;
        let dst = document.getElementById("destination").value;
        console.log("eval = "+eval);
        if(src === null){
          alert('å‡ºç™ºåœ°ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“');
          return;
        }
        else if(dst === null){
          alert('ç›®çš„åœ°ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“');
          return;
        }

        src = "ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒãƒ¼ãƒˆåºƒå³¶æ®µåŸæ±åº—";
        dst = "ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«åºƒå³¶åºœä¸­";
        $("#origin").val(src);
        $("#destination").val(dst);

        map = new google.maps.Map(document.getElementById("map"), {
          center: new google.maps.LatLng(34.391531, 132.490962), 
          zoom: 16
        });

        
        let arrayMarker =[];
        let markerData = getMarkerData(eval);

        for(let i=0;i<markerDataGood.length;i++){
          arrayMarker.push({ location: new google.maps.LatLng({
          lat: markerData[i]["lat"],
          lng: markerData[i]["lng"]
        }), stopover: true });
        }

        let routeRequest = {
          origin: new google.maps.LatLng(34.386424, 132.480188), // å‡ºç™ºåœ°
          destination: new google.maps.LatLng(34.393155, 132.498090), // ç›®çš„åœ°
          waypoints: arrayMarker,
          travelMode: google.maps.DirectionsTravelMode.DRIVING, 
        };
      
        let d = new google.maps.DirectionsService(); // ãƒ«ãƒ¼ãƒˆæ¤œç´¢ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        let r = new google.maps.DirectionsRenderer({ // ãƒ«ãƒ¼ãƒˆæç”»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
          map: map, // æç”»å…ˆã®åœ°å›³
          suppressMarkers: true,
          preserveViewport: true, // æç”»å¾Œã«ä¸­å¿ƒç‚¹ã‚’ãšã‚‰ã•ãªã„
        });
        // ãƒ«ãƒ¼ãƒˆæ¤œç´¢
        d.route(routeRequest, function(result, status){
        // OKã®å ´åˆãƒ«ãƒ¼ãƒˆæç”»
          if (status == google.maps.DirectionsStatus.OK) {
              r.setDirections(result);
          }
        }); 

        dispMakers($("[name=evaluation]").val());
      }

      // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®é¸æŠå¤‰æ›´æ™‚ã®å‡¦ç†
      $("[name=evaluation]").change(function() {
        var val = $("[name=evaluation]").val();
        dispMakers(val);
      });
      // çµŒè·¯é¸æŠãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
      $("#search").on("click", function() {
        initMap();
        // ã¨ã‚Šã‚ãˆãšçµŒè·¯ã¯ã¹ãŸæ›¸ãã§ã™ãƒ»ãƒ»ãƒ»
        var origin = "ç†Šå¹³è£½ä½œæ‰€ ã‚·ãƒ§ãƒ¼ãƒ«ãƒ¼ãƒ ï¼ˆåºƒå³¶ï¼‰";
        var destination = "çœŒç«‹åºƒå³¶ç—…é™¢";
        $("#origin").val(origin);
        $("#destination").val(destination);
        // çµŒè·¯è¡¨ç¤ºç”¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
        var DS = new google.maps.DirectionsService();
        var DR = new google.maps.DirectionsRenderer({
          suppressMarkers: true
        });
        //  mapã¨DirectionsServiceã‚’ç´ã¥ã‘ã‚‹
        DR.setMap(map);
        // çµŒè·¯æ¤œç´¢ç”¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆã¹ãŸæ›¸ããƒ»ãƒ»ãƒ»ï¼‰
        var request = {
          origin: origin,
          destination: destination,
          travelMode: google.maps.TravelMode.DRIVING
        };
        // çµŒè·¯è¡¨ç¤ºï¼ˆã¹ãŸæ›¸ããƒ»ãƒ»ãƒ»ï¼‰
        DS.route(request, function(result, status) {
          DR.setDirections(result);
        });
      });
      //  åœ°åã‚’æ¤œç´¢
      $("#routeSearch").on("click", function() {
        searchRoute($("[name=evaluation]").val());
      });

      // $("#snsLink").on("click", function() {
      //   let plcSrvice = new google.maps.places.PlacesService(map);

      //   plcSrvice.nearbySearch(
      //     {
      //       location: new google.maps.LatLng(34.386424, 132.480188),
      //       radius: '800',
      //       type: ['restaurant'],
      //       keyword: 'ãƒ©ãƒ¼ãƒ¡ãƒ³',
      //     },
      //     plcServiceCallBack
      //   );

      // });
    
      //  function plcServiceCallBack(results, status, pagination){
      //   if(status == google.maps.places.PlacesService.OK){
      //     resLocationName.push(results);
      //     if(pagination.nextPage){
      //       setTimeout(pagination.nextPage(), 1000);
      //     }
      //   }
      //   console.log(results);

      //   let index = Math.floor(Math.random() * (results.length));
      //   let place = results[index];
      //   let keyName = place.name;
      //   keyName = keyName.trim();
      //   console.log(keyName);

      //   let jumpPage = 'https://www.instagram.com/explore/tags/' + keyName;

      //   window.open(jumpPage,'subwin','width=540,height=640,resizable=yes')
      //   console.log("new window ");

      // }

    </script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=___________&libraries=places&callback=initMap"
      async
      defer
    ></script>
  </body>
</html>
